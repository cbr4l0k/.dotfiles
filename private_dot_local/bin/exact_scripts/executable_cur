#!/usr/bin/env bash
# Description: Manage ~/current symlink to track working directory
# Usage: cur [show|go|force]
# By: Juan P. Sierra Useche <cbr4l0k>

set -euo pipefail

LINK="$HOME/current"
usage() {
  cat <<'EOF'
Usage:
  cur             Set ~/current -> physical $PWD
  cur show        Show where ~/current points
  cur go          Start a subshell in ~/current
  cur force       Replace ~/current even if it is a real directory
EOF
}

phys_pwd() { pwd -P; }  # resolve all symlinks in $PWD

cmd="${1:-}"

case "$cmd" in
  "" )
    target="$(phys_pwd)"
    # Refuse to overwrite a non-symlink unless forced
    if [ -e "$LINK" ] && [ ! -L "$LINK" ]; then
      echo "Refusing: $LINK exists and is not a symlink. Use 'cur force' to replace." >&2
      exit 1
    fi
    ln -sfn -- "$target" "$LINK"
    printf "ðŸ”— set %s â†’ %s\n" "$LINK" "$target"
    ;;
  show )
    if [ -L "$LINK" ]; then
      # Prefer realpath if available; fall back to readlink (prints relative path if that's what was stored)
      if command -v realpath >/dev/null 2>&1; then
        realpath "$LINK"
      else
        readlink "$LINK"
      fi
    else
      echo "No ~/current symlink yet."
      exit 1
    fi
    ;;
  go )
    if [ -L "$LINK" ]; then
      cd -P -- "$LINK" || exit 1
      exec "${SHELL:-/bin/bash}"
    else
      echo "No ~/current symlink yet. Run 'cu' in a project first."
      exit 1
    fi
    ;;
  force )
    target="$(phys_pwd)"
    rm -rf -- "$LINK"
    ln -s -- "$target" "$LINK"
    printf "ðŸ”— set %s â†’ %s\n" "$LINK" "$(basename "$target")"
    ;;
  -h|--help|help )
    usage
    ;;
  * )
    echo "Unknown option: $cmd" >&2
    usage
    exit 2
    ;;
esac
